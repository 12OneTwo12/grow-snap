ifndef::snippets[]
:snippets: ../../build/generated-snippets
endif::[]
:doctype: book
:icons: font
:source-highlighter: highlightjs
:toc: left
:toclevels: 3
:sectlinks:

[[auth-api]]
= 인증 API

[[auth-overview]]
== 개요

OAuth2 소셜 로그인 및 JWT 기반 인증 시스템을 제공합니다.

=== 인증 흐름

1. **OAuth2 로그인**
   - 사용자가 프론트엔드에서 "Google 로그인" 버튼 클릭
   - 프론트엔드 → `/oauth2/authorization/google` 리다이렉트
   - Spring Security → Google OAuth2 인증 페이지로 리다이렉트
   - Google 인증 성공 → `/api/v1/auth/oauth2/callback/google` 콜백
   - 백엔드가 JWT Access Token + Refresh Token 생성
   - 프론트엔드 `/auth/oauth2/redirect`로 리다이렉트 (쿼리 파라미터로 토큰 전달)

2. **Access Token 갱신**
   - Access Token 만료 시 Refresh Token으로 새로운 Access Token 발급

3. **로그아웃**
   - Redis에 저장된 Refresh Token 삭제

=== JWT 토큰 정보

[cols="1,2,1"]
|===
|토큰 종류|용도|만료 시간

|Access Token
|API 요청 인증용 (Authorization 헤더에 포함)
|1시간

|Refresh Token
|Access Token 갱신용 (Redis에 저장)
|14일
|===

[[auth-refresh-token]]
== Access Token 갱신

Refresh Token을 사용하여 새로운 Access Token을 발급받습니다.

=== HTTP Request

include::{snippets}/auth/refresh-token/http-request.adoc[]

=== Request Fields

include::{snippets}/auth/refresh-token/request-fields.adoc[]

=== HTTP Response

include::{snippets}/auth/refresh-token/http-response.adoc[]

=== Response Fields

include::{snippets}/auth/refresh-token/response-fields.adoc[]

=== cURL Request

include::{snippets}/auth/refresh-token/curl-request.adoc[]

=== 예외 상황

[cols="1,2"]
|===
|HTTP Status|설명

|400 Bad Request
|Refresh Token이 누락되거나 형식이 잘못됨

|500 Internal Server Error
|Refresh Token이 유효하지 않거나 Redis에 저장된 토큰과 불일치
|===

[[auth-logout]]
== 로그아웃

Redis에 저장된 Refresh Token을 삭제하여 로그아웃 처리합니다.

=== HTTP Request

include::{snippets}/auth/logout/http-request.adoc[]

=== Request Fields

include::{snippets}/auth/logout/request-fields.adoc[]

=== HTTP Response

include::{snippets}/auth/logout/http-response.adoc[]

=== cURL Request

include::{snippets}/auth/logout/curl-request.adoc[]

=== 예외 상황

[cols="1,2"]
|===
|HTTP Status|설명

|400 Bad Request
|Refresh Token이 누락되거나 형식이 잘못됨

|500 Internal Server Error
|Refresh Token이 유효하지 않음
|===

[[auth-oauth2-google]]
== Google OAuth2 로그인

Google 소셜 로그인을 통한 사용자 인증을 제공합니다.

=== 로그인 시작

프론트엔드에서 다음 URL로 리다이렉트하여 Google 로그인을 시작합니다:

[source]
----
GET /oauth2/authorization/google
----

=== 로그인 콜백

Google 인증 완료 후 백엔드가 자동으로 처리하는 콜백 엔드포인트입니다:

[source]
----
GET /api/v1/auth/oauth2/callback/google?code={authorization_code}
----

=== 로그인 성공 리다이렉트

백엔드가 JWT 토큰을 생성하고 프론트엔드로 리다이렉트합니다:

[source]
----
GET {FRONTEND_URL}/auth/oauth2/redirect?accessToken={jwt_access_token}&refreshToken={jwt_refresh_token}&userId={user_id}&email={user_email}
----

프론트엔드는 쿼리 파라미터에서 토큰을 추출하여 저장합니다.

=== 쿼리 파라미터

[cols="1,2,1"]
|===
|파라미터|설명|예시

|accessToken
|JWT Access Token (1시간 만료)
|eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

|refreshToken
|JWT Refresh Token (14일 만료)
|eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

|userId
|사용자 UUID
|550e8400-e29b-41d4-a716-446655440000

|email
|사용자 이메일
|user@example.com
|===

=== 로그인 실패 리다이렉트

인증 실패 시 백엔드가 에러와 함께 프론트엔드로 리다이렉트합니다:

[source]
----
GET {FRONTEND_URL}/auth/oauth2/error?error={error_message}
----

[[auth-protected-api]]
== 인증이 필요한 API 호출

Access Token을 사용하여 보호된 API를 호출합니다.

=== Authorization 헤더

[source,http]
----
GET /api/v1/users/me HTTP/1.1
Host: localhost:8080
Authorization: Bearer {access_token}
----

=== Access Token 만료 처리

1. API 요청 시 `401 Unauthorized` 응답을 받으면 Access Token이 만료된 것입니다
2. Refresh Token으로 `/api/v1/auth/refresh` API를 호출하여 새 Access Token 발급
3. 새 Access Token으로 원래 API 재요청

=== Refresh Token 만료 처리

Refresh Token도 만료되면 사용자는 다시 로그인해야 합니다.

[[auth-security]]
== 보안 고려사항

=== 토큰 저장

- **Access Token**: 메모리 또는 SessionStorage에 저장 (XSS 공격 시 탈취 위험 감수)
- **Refresh Token**: HttpOnly Cookie에 저장 권장 (현재 구현은 쿼리 파라미터로 전달하므로 프론트엔드 구현 주의)

=== CORS 설정

현재 허용된 Origin:
- `http://localhost:3000` (React 개발 환경)
- `http://localhost:5173` (Vite 개발 환경)

프로덕션 환경에서는 실제 프론트엔드 도메인으로 변경 필요합니다.

=== 환경 변수

다음 환경 변수를 반드시 설정해야 합니다:

[cols="1,2,1"]
|===
|변수명|설명|예시

|GOOGLE_CLIENT_ID
|Google OAuth2 클라이언트 ID
|123456789-abc.apps.googleusercontent.com

|GOOGLE_CLIENT_SECRET
|Google OAuth2 클라이언트 시크릿
|GOCSPX-...

|JWT_SECRET
|JWT 서명 키 (최소 256비트)
|your-256-bit-secret-key...

|FRONTEND_URL
|프론트엔드 URL
|http://localhost:3000

|REDIS_HOST
|Redis 호스트
|localhost

|REDIS_PORT
|Redis 포트
|6379
|===
